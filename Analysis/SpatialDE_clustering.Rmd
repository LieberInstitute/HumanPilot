---
title: "SpatialDE clustering"
author: "Lukas Weber"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
    html_document:
        toc: true
        toc_depth: 2
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


# SpatialDE clustering

This script contains code for several versions of data-driven clustering to reproduce the DLPFC layer structure in our dataset, using various combinations of SpatialDE genes and spatial dimensions. Clustering results are evaluated using manually annotated layers from Kristen Maynard as ground truth.

```{r, message = FALSE}
library(SingleCellExperiment)
library(scran)
library(scater)
library(readr)
library(readxl)
library(dplyr)
library(uwot)
library(mclust)
library(aricode)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
```


## Load data

Load SingleCellExperiment object from Leo's analyses.

```{r}
# load scran output file
load("../../data/Human_DLPFC_Visium_processedData_sce_scran.Rdata")
sce

# sample names
sample_names <- paste0("sample_", unique(colData(sce)$sample_name))
sample_names
```


## Load SpatialDE genes

Load lists of significant SpatialDE genes for each sample (output from previous script "SpatialDE_subsampling_comparison.Rmd").

```{r}
# load spreadsheets containing SpatialDE gene lists
genes_SpatialDE_files <- list.files(
    "../outputs/SpatialDE_subsampling_comparison", 
    pattern = "^SpatialDE_genes_sig_all_[0-9]+\\.csv$", full.names = TRUE
)
genes_SpatialDE_files_pooled <- list.files(
    "../outputs/SpatialDE_subsampling_comparison", 
    pattern = "^SpatialDE_genes_sig_all_pooled\\.csv$", full.names = TRUE
)

genes_SpatialDE_files
genes_SpatialDE_files_pooled

genes_SpatialDE <- lapply(genes_SpatialDE_files, read_csv)

genes_SpatialDE_pooled <- read_csv(genes_SpatialDE_files_pooled)

stopifnot(all(sample_names == paste0("sample_", gsub("\\.csv$", "", gsub("^.*_", "", genes_SpatialDE_files)))))

names(genes_SpatialDE) <- sample_names

# number of genes
sapply(genes_SpatialDE, nrow)
nrow(genes_SpatialDE_pooled)
```


## Load pseudobulk genes (from Leo's analyses)

```{r}
# load spreadsheet of significant genes for pseudobulk layers (from Leo's analyses)
sig_genes <- read_csv("Layer_Guesses/sig_genes.csv")
sig_genes

genes_pseudobulk <- sig_genes[, c("ensembl", "gene")]
colnames(genes_pseudobulk) <- c("gene_id", "gene_name")

dim(genes_pseudobulk)

# remove duplicates (i.e. genes identified for multiple layers)
genes_pseudobulk <- distinct(genes_pseudobulk)

dim(genes_pseudobulk)
```


## Load known marker genes (from Kristen)

```{r}
# load spreadsheet of known marker genes (from Kristen)
KRM_Layer_Markers <- read_xlsx("KRM_Layer_Markers.xlsx")
KRM_Layer_Markers
dim(KRM_Layer_Markers)

marker_genes_KRM <- KRM_Layer_Markers$Gene

# get gene IDs (note: not all available in "sce" object)
sum(toupper(marker_genes_KRM) %in% rowData(sce)$gene_name)

genes_markers <- data.frame(gene_name = toupper(marker_genes_KRM))
genes_markers$gene_id <- rowData(sce)$gene_id[match(genes_markers$gene_name, rowData(sce)$gene_name)]

dim(genes_markers)
sum(is.na(genes_markers$gene_id))
```


## Load ground truth

Load ground truth cluster labels (manually annotated DLPFC layers from Kristen Maynard).

```{r}
# load KRM manual layer labels
KRM_manual_layers_part1 <- read_csv("../../from_Slack/KRM_manual_layers/spatialLIBD_layerGuesses_2019-12-19 19_49_57_Merged.csv")
KRM_manual_layers_part2 <- read_csv("../../from_Slack/KRM_manual_layers/spatialLIBD_layerGuesses_2019-12-30 17_35_40_Combined2.csv")

KRM_manual_layers <- rbind(KRM_manual_layers_part1, KRM_manual_layers_part2)

table(KRM_manual_layers$layer)
table(KRM_manual_layers$sample_name, KRM_manual_layers$layer)

# re-code "Layer 2/3" as "Layer 3" (for samples 151669, 151670, 151671, 151672)
KRM_manual_layers$layer[KRM_manual_layers$layer == "Layer 2/3"] <- "Layer 3"

KRM_manual_layers$layer <- gsub(" ", "_", KRM_manual_layers$layer)

KRM_manual_layers
table(KRM_manual_layers$layer)
table(KRM_manual_layers$sample_name, KRM_manual_layers$layer)
```


## Clustering

Run the following clustering analyses:

- clustering on top 50 PCs on SpatialDE significant genes for each sample
- clustering on top 50 PCs on SpatialDE significant genes pooled
- clustering on top 50 PCs on HVGs
- clustering on top 50 PCs on pseudobulk layer genes (from Leo's analyses; 198 genes)
- clustering on top 50 PCs on known marker genes (from Kristen; 77 out of 81 genes)

- clustering on top 10 UMAPs on top 50 PCs on SpatialDE significant genes for each sample
- clustering on top 10 UMAPs on top 50 PCs on SpatialDE significant genes pooled
- clustering on top 10 UMAPs on top 50 PCs on HVGs
- clustering on top 10 UMAPs on pseudobulk layer genes (from Leo's analyses; 198 genes)
- clustering on top 10 UMAPs on known marker genes (from Kristen; 77 out of 81 genes)

- clustering on top 50 PCs on SpatialDE significant genes for each sample + 2 scaled spatial dimensions
- clustering on top 50 PCs on SpatialDE significant genes pooled + 2 scaled spatial dimensions
- clustering on top 50 PCs on HVGs + 2 scaled spatial dimensions
- clustering on top 50 PCs on pseudobulk layer genes (from Leo's analyses; 198 genes) + 2 scaled spatial dimensions
- clustering on top 50 PCs on known marker genes (from Kristen; 77 out of 81 genes) + 2 scaled spatial dimensions

- clustering on top 10 UMAPs on top 50 PCs on SpatialDE significant genes for each sample + 2 scaled spatial dimensions
- clustering on top 10 UMAPs on top 50 PCs on SpatialDE significant genes pooled + 2 scaled spatial dimensions
- clustering on top 10 UMAPs on top 50 PCs on HVGs + 2 scaled spatial dimensions
- clustering on top 10 UMAPs on pseudobulk layer genes (from Leo's analyses; 198 genes) + 2 scaled spatial dimensions
- clustering on top 10 UMAPs on known marker genes (from Kristen; 77 out of 81 genes) + 2 scaled spatial dimensions


Notes:

- spatial dimensions are scaled to a range approximately comparable to the other dimensions; no z-scaling of spatial dimensions since these are physical coordinates

- clustering is performed using Bioconductor graph-based clustering number of clusters equal to known number of ground truth layers

```{r}
# parameters
n_umap <- 10
max_spatial <- 1
n_neighbors <- 10
n_clus <- 8


d_plot <- data.frame()


# function to sort cluster labels by descending frequency (from Leo)
sort_clusters <- function(clusters, map_subset = NULL) {
    if (is.null(map_subset)) {
        map_subset <- rep(TRUE, length(clusters))
    }
    map <- rank(length(clusters[map_subset]) - table(clusters[map_subset]), ties.method = "first")
    res <- map[clusters]
    factor(res)
}


# run once per sample
for (i in seq_along(sample_names)) {
    
    # select spots from this sample
    sce_sub <- sce[, colData(sce)$sample_name == gsub("^sample_", "", sample_names[i])]
    dim(sce_sub)
    
    
    # ----------------------
    # get spatial dimensions
    # ----------------------
    
    # extract x-y coordinates of spots (note: y coordinate is reversed)
    xy_coords <- data.frame(
        x_coord = colData(sce_sub)[, c("imagecol")], 
        y_coord = -colData(sce_sub)[, c("imagerow")]
    )
    
    dims_spatial <- xy_coords
    colnames(dims_spatial) <- c("spatial_x", "spatial_y")
    rownames(dims_spatial) <- colnames(sce_sub)
    dim(dims_spatial)
    stopifnot(nrow(dims_spatial) == ncol(sce_sub))
    
    # scale spatial dimensions
    apply(dims_spatial, 2, range)
    dims_spatial <- apply(as.matrix(dims_spatial), 2, function(col) {
        (col - min(col)) / (max(col) - min(col)) * (2 * max_spatial) - max_spatial
    })
    rownames(dims_spatial) <- colnames(sce_sub)
    apply(dims_spatial, 2, range)
    dim(dims_spatial)
    stopifnot(nrow(dims_spatial) == ncol(sce_sub))
    
    
    # -----------------------
    # get ground truth labels
    # -----------------------
    
    # note ground truth labels are not available for all spots
    KRM_manual_layers_sub <- filter(KRM_manual_layers, sample_name == gsub("^sample_", "", sample_names[i]))
    dim(KRM_manual_layers_sub)
    
    ground_truth_sub <- data.frame(
        truth = rep(NA, ncol(sce_sub))
    )
    rownames(ground_truth_sub) <- colnames(sce_sub)
    ground_truth_sub[KRM_manual_layers_sub$spot_name, "truth"] <- KRM_manual_layers_sub$layer
    dim(ground_truth_sub)
    stopifnot(nrow(ground_truth_sub) == ncol(sce_sub))
    
    
    # ---------------------------------------------
    # extract and calculate features (PCA and UMAP)
    # ---------------------------------------------
    
    ### HVGs
    
    # extract top 50 PCs on HVGs
    dims_HVG_PCA <- reducedDim(sce_sub, type = "PCA")
    dim(dims_HVG_PCA)
    stopifnot(nrow(dims_HVG_PCA) == ncol(sce_sub))
    
    
    # run UMAP on top 50 PCs on HVGs
    set.seed(1234)
    out_umap_hvgs <- umap(dims_HVG_PCA, scale = TRUE, n_components = n_umap)
    
    dims_HVG_UMAP <- out_umap_hvgs
    colnames(dims_HVG_UMAP) <- paste0("UMAP", seq_len(n_umap))
    rownames(dims_HVG_UMAP) <- colnames(sce_sub)
    dim(dims_HVG_UMAP)
    stopifnot(nrow(dims_HVG_UMAP) == ncol(sce_sub))
    
    
    ### SpatialDE significant genes (sample-specific)
    
    # run PCA on SpatialDE significant genes (sample-specific)
    logcounts_spatialde <- logcounts(sce_sub[genes_SpatialDE[[sample_names[i]]]$gene_id, ])
    
    # note scater::calculatePCA has random seed
    set.seed(1234)
    out_pca_spatialde <- calculatePCA(logcounts_spatialde, ncomponents = 50)
    
    dims_SpatialDE_PCA <- out_pca_spatialde
    rownames(dims_SpatialDE_PCA) <- colnames(sce_sub)
    dim(dims_SpatialDE_PCA)
    stopifnot(nrow(dims_SpatialDE_PCA) == ncol(sce_sub))
    
    
    # run UMAP on SpatialDE significant genes (sample-specific)
    set.seed(1234)
    out_umap_spatialde <- umap(dims_SpatialDE_PCA, scale = TRUE, n_components = n_umap)
    
    dims_SpatialDE_UMAP <- out_umap_spatialde
    colnames(dims_SpatialDE_UMAP) <- paste0("UMAP", seq_len(n_umap))
    rownames(dims_SpatialDE_UMAP) <- colnames(sce_sub)
    dim(dims_SpatialDE_UMAP)
    stopifnot(nrow(dims_SpatialDE_UMAP) == ncol(sce_sub))
    
    
    ### SpatialDE significant genes (pooled)
    
    # run PCA on SpatialDE significant genes (pooled)
    logcounts_spatialde_pool <- logcounts(sce_sub[genes_SpatialDE_pooled$gene_id, ])
    
    # note scater::calculatePCA has random seed
    set.seed(1234)
    out_pca_spatialde_pool <- calculatePCA(logcounts_spatialde_pool, ncomponents = 50)
    
    dims_SpatialDE_pool_PCA <- out_pca_spatialde_pool
    rownames(dims_SpatialDE_pool_PCA) <- colnames(sce_sub)
    dim(dims_SpatialDE_pool_PCA)
    stopifnot(nrow(dims_SpatialDE_pool_PCA) == ncol(sce_sub))
    
    
    # run UMAP on SpatialDE significant genes (pooled)
    set.seed(1234)
    out_umap_spatialde_pool <- umap(dims_SpatialDE_pool_PCA, scale = TRUE, n_components = n_umap)
    
    dims_SpatialDE_pool_UMAP <- out_umap_spatialde_pool
    colnames(dims_SpatialDE_pool_UMAP) <- paste0("UMAP", seq_len(n_umap))
    rownames(dims_SpatialDE_pool_UMAP) <- colnames(sce_sub)
    dim(dims_SpatialDE_pool_UMAP)
    stopifnot(nrow(dims_SpatialDE_pool_UMAP) == ncol(sce_sub))
    
    
    ### pseudobulk layer genes (from Leo's analyses; 198 genes)
    
    # run PCA on pseudobulk layer genes (from Leo's analyses; 198 genes)
    logcounts_pseudobulk <- logcounts(sce_sub[genes_pseudobulk$gene_id, ])
    
    # note: use 'prcomp' instead of 'calculatePCA' due to small number of genes
    out_pca_pseudobulk <- prcomp(t(as.matrix(logcounts_pseudobulk)))$x[, 1:50]
    
    dims_pseudobulk_PCA <- out_pca_pseudobulk
    rownames(dims_pseudobulk_PCA) <- colnames(sce_sub)
    dim(dims_pseudobulk_PCA)
    stopifnot(nrow(dims_pseudobulk_PCA) == ncol(sce_sub))
    
    
    # run UMAP on pseudobulk layer genes (from Leo's analyses; 198 genes)
    set.seed(1234)
    out_umap_pseudobulk <- umap(dims_pseudobulk_PCA, scale = TRUE, n_components = n_umap)
    
    dims_pseudobulk_UMAP <- out_umap_pseudobulk
    colnames(dims_pseudobulk_UMAP) <- paste0("UMAP", seq_len(n_umap))
    rownames(dims_pseudobulk_UMAP) <- colnames(sce_sub)
    dim(dims_pseudobulk_UMAP)
    stopifnot(nrow(dims_pseudobulk_UMAP) == ncol(sce_sub))
    
    
    ### known marker genes (from Kristen; 77 out of 81 genes)
    
    # run PCA on known marker genes (from Kristen; 77 out of 81 genes)
    # note: remove NAs
    logcounts_markers <- logcounts(sce_sub[na.omit(genes_markers$gene_id), ])
    
    # note: use 'prcomp' instead of 'calculatePCA' due to small number of genes
    out_pca_markers <- prcomp(t(as.matrix(logcounts_markers)))$x[, 1:50]
    
    dims_markers_PCA <- out_pca_markers
    rownames(dims_markers_PCA) <- colnames(sce_sub)
    dim(dims_markers_PCA)
    stopifnot(nrow(dims_markers_PCA) == ncol(sce_sub))
    
    
    # run UMAP on known marker genes (from Kristen; 77 out of 81 genes)
    set.seed(1234)
    out_umap_markers <- umap(dims_markers_PCA, scale = TRUE, n_components = n_umap)
    
    dims_markers_UMAP <- out_umap_markers
    colnames(dims_markers_UMAP) <- paste0("UMAP", seq_len(n_umap))
    rownames(dims_markers_UMAP) <- colnames(sce_sub)
    dim(dims_markers_UMAP)
    stopifnot(nrow(dims_markers_UMAP) == ncol(sce_sub))
    
    
    # --------------------------------------------------------------------------------------------
    # run clustering and calculate Adjusted Rand Index (ARI) / Normalized Mutual Information (NMI)
    # --------------------------------------------------------------------------------------------
    
    # using graph-based clustering (see Bioconductor OSCA book)
    
    # convenience function; note uses some external variables from above
    run_clustering_ARI <- function(input, method) {
        dims_clus <- input
        
        set.seed(1234)
        g <- buildSNNGraph(t(dims_clus), k = n_neighbors, d = ncol(dims_clus))
        g_walk <- igraph::cluster_walktrap(g)
        clus <- igraph::cut_at(g_walk, n = n_clus)
        clus <- sort_clusters(clus)
        
        table(clus)
        stopifnot(length(clus) == nrow(dims_clus))
        stopifnot(length(clus) == nrow(ground_truth_sub))
        
        truth <- ground_truth_sub$truth
        table(clus, truth)
        
        df_pairs <- na.omit(data.frame(clus = clus, truth = truth))
        
        out_ARI <- adjustedRandIndex(df_pairs$clus, df_pairs$truth)
        out_NMI <- NMI(df_pairs$clus, df_pairs$truth)
        
        data.frame(
            spot_name = as.character(rownames(dims_clus)), 
            xy_coords, 
            sample_name = as.character(sample_names[i]), 
            method = as.character(method), 
            cluster = as.numeric(clus), 
            truth = as.character(truth), 
            ARI = out_ARI, 
            NMI = out_NMI, 
            stringsAsFactors = FALSE
        )
    }
    
    
    # run clustering for each method
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_HVG_PCA, method = "HVG_PCA"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_HVG_UMAP, method = "HVG_UMAP"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_SpatialDE_PCA, method = "SpatialDE_PCA"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_SpatialDE_UMAP, method = "SpatialDE_UMAP"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_SpatialDE_pool_PCA, method = "SpatialDE_pool_PCA"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_SpatialDE_pool_UMAP, method = "SpatialDE_pool_UMAP"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_pseudobulk_PCA, method = "pseudobulk_PCA"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_pseudobulk_UMAP, method = "pseudobulk_UMAP"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_markers_PCA, method = "markers_PCA"))
    d_plot <- rbind(d_plot, run_clustering_ARI(dims_markers_UMAP, method = "markers_UMAP"))
    
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_HVG_PCA, dims_spatial), method = "HVG_PCA_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_HVG_UMAP, dims_spatial), method = "HVG_UMAP_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_SpatialDE_PCA, dims_spatial), method = "SpatialDE_PCA_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_SpatialDE_UMAP, dims_spatial), method = "SpatialDE_UMAP_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_SpatialDE_pool_PCA, dims_spatial), method = "SpatialDE_pool_PCA_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_SpatialDE_pool_UMAP, dims_spatial), method = "SpatialDE_pool_UMAP_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_pseudobulk_PCA, dims_spatial), method = "pseudobulk_PCA_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_pseudobulk_UMAP, dims_spatial), method = "pseudobulk_UMAP_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_markers_PCA, dims_spatial), method = "markers_PCA_spatial"))
    d_plot <- rbind(d_plot, run_clustering_ARI(cbind(dims_markers_UMAP, dims_spatial), method = "markers_UMAP_spatial"))
}


# re-order method names for plotting
method_names <- c(
    "SpatialDE_PCA", "SpatialDE_pool_PCA", "HVG_PCA", "pseudobulk_PCA", "markers_PCA", 
    "SpatialDE_UMAP", "SpatialDE_pool_UMAP", "HVG_UMAP", "pseudobulk_UMAP", "markers_UMAP", 
    "SpatialDE_PCA_spatial", "SpatialDE_pool_PCA_spatial", "HVG_PCA_spatial", "pseudobulk_PCA_spatial", "markers_PCA_spatial", 
    "SpatialDE_UMAP_spatial", "SpatialDE_pool_UMAP_spatial", "HVG_UMAP_spatial", "pseudobulk_UMAP_spatial", "markers_UMAP_spatial"
)

ix_unsupervised <- !(grepl("pseudobulk", method_names) | grepl("markers", method_names))
method_names_unsupervised <- method_names[ix_unsupervised]
method_names_semisupervised <- method_names[!ix_unsupervised]
```


## Plots: clustering

```{r, fig.width = 12.75, fig.height = 5.5}
# separate plots for each sample
p_clustering_unsupervised <- list()
p_clustering_semisupervised <- list()

for (i in seq_along(sample_names)) {
    
    d_plot_sub <- d_plot[d_plot$sample_name == sample_names[i], ]
    
    d_plot_sub$method <- factor(d_plot_sub$method, levels = method_names)
    d_plot_sub$cluster <- as.factor(d_plot_sub$cluster)
    d_plot_sub$truth <- as.factor(d_plot_sub$truth)
    
    # separate plots for unsupervised and semisupervised
    d_plot_sub_unsupervised <- d_plot_sub[d_plot_sub$method %in% method_names_unsupervised, ]
    d_plot_sub_semisupervised <- d_plot_sub[d_plot_sub$method %in% method_names_semisupervised, ]
    
    p_clustering_unsupervised[[i]] <- 
        ggplot(d_plot_sub_unsupervised, aes(x = x_coord, y = y_coord, color = cluster)) + 
            facet_wrap(~ method, nrow = 2) + 
            geom_point(size = 0.25, alpha = 1) + 
            coord_fixed() + 
            scale_color_brewer(palette = "Paired") + 
            ggtitle(paste0("Clustering (unsupervised): sample ", gsub("^sample_", "", sample_names[i]))) + 
            theme_bw() + 
            theme(axis.title.x = element_blank(), 
                  axis.title.y = element_blank())
    
    print(p_clustering_unsupervised[[i]])
    
    filename <- paste0("../plots/SpatialDE_clustering/clustering_unsupervised_sample_", 
                       gsub("^sample_", "", sample_names[i]), ".png")
    ggsave(filename, width = 12.75, height = 5.5)
    
    
    p_clustering_semisupervised[[i]] <- 
        ggplot(d_plot_sub_semisupervised, aes(x = x_coord, y = y_coord, color = cluster)) + 
            facet_wrap(~ method, nrow = 2) + 
            geom_point(size = 0.25, alpha = 1) + 
            coord_fixed() + 
            scale_color_brewer(palette = "Paired") + 
            ggtitle(paste0("Clustering (semisupervised): sample ", gsub("^sample_", "", sample_names[i]))) + 
            theme_bw() + 
            theme(axis.title.x = element_blank(), 
                  axis.title.y = element_blank())
    
    print(p_clustering_semisupervised[[i]])
    
    filename <- paste0("../plots/SpatialDE_clustering/clustering_semisupervised_sample_", 
                       gsub("^sample_", "", sample_names[i]), ".png")
    ggsave(filename, width = 9, height = 5.5)
}
```


## Plots: ground truth

```{r, fig.width = 4.5, fig.height = 3.75}
# separate plots for each sample
p_ground_truth <- list()

for (i in seq_along(sample_names)) {
    
    d_plot_sub <- d_plot[d_plot$sample_name == sample_names[i], ]
    
    d_plot_sub$method <- factor(d_plot_sub$method, levels = method_names)
    d_plot_sub$cluster <- as.factor(d_plot_sub$cluster)
    d_plot_sub$truth <- as.factor(d_plot_sub$truth)
    
    # ground truth is the same for each method
    d_plot_truth <- d_plot_sub[d_plot_sub$method == method_names[1], ]
    d_plot_truth <- na.omit(d_plot_truth)
    
    p_ground_truth[[i]] <- 
        ggplot(d_plot_truth, aes(x = x_coord, y = y_coord, color = truth)) + 
            geom_point(size = 0.5, alpha = 1) + 
            coord_fixed() + 
            scale_color_brewer(palette = "Paired") + 
            ggtitle(paste0("Ground truth: sample ", gsub("^sample_", "", sample_names[i]))) + 
            theme_bw() + 
            theme(axis.title.x = element_blank(), 
                  axis.title.y = element_blank())
    
    print(p_ground_truth[[i]])
    
    filename <- paste0("../plots/SpatialDE_clustering/ground_truth_sample_", 
                       gsub("^sample_", "", sample_names[i]), ".png")
    ggsave(filename, width = 4.5, height = 3.75)
}
```


## Plots: Adjusted Rand Index (ARI)

```{r, fig.width = 4.5, fig.height = 4.5}
# separate plots for each sample
p_ARI <- list()

for (i in seq_along(sample_names)) {
    
    d_plot_sub <- d_plot[d_plot$sample_name == sample_names[i], ]
    d_plot_sub$method <- factor(d_plot_sub$method, levels = method_names)
    
    d_plot_ARI <- distinct(d_plot_sub[, c("sample_name", "method", "ARI")])
    
    colors <- c(rep(c(rep("blue", 2), "forestgreen", "purple", "deeppink3"), 2), 
                rep(c(rep("mediumblue", 2), "darkgreen", "purple3", "deeppink4"), 2))
    
    p_ARI[[i]] <- 
        ggplot(d_plot_ARI, aes(x = method, y = ARI, color = method)) + 
            geom_point(shape = 4, stroke = 2) + 
            scale_color_manual(values = colors) + 
            ylim(c(-0.1, 0.5)) + 
            ggtitle(paste0("Adjusted Rand Index: sample ", gsub("^sample_", "", sample_names[i]))) + 
            theme_bw() + 
            theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), 
                  axis.title.x = element_blank(), 
                  legend.position = "none")
    
    print(p_ARI[[i]])
    
    filename <- paste0("../plots/SpatialDE_clustering/ARI_sample_", 
                       gsub("^sample_", "", sample_names[i]), ".png")
    ggsave(filename, width = 4.5, height = 4.5)
}
```


```{r, fig.width = 5, fig.height = 5}
# combined boxplots showing all samples for each method
d_plot_ARI_all <- distinct(d_plot[, c("sample_name", "method", "ARI")])

d_plot_ARI_all$method <- factor(d_plot_ARI_all$method, levels = method_names)

colors <- c(rep(c(rep("blue", 2), "forestgreen", "purple", "deeppink3"), 2), 
            rep(c(rep("mediumblue", 2), "darkgreen", "purple3", "deeppink4"), 2))

p_ARI_all <- 
    ggplot(d_plot_ARI_all, aes(x = method, y = ARI, color = method)) + 
        geom_boxplot() + 
        scale_color_manual(values = colors) + 
        ylim(c(-0.1, 0.5)) + 
        ggtitle("Adjusted Rand Index: all samples") + 
        theme_bw() + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), 
              axis.title.x = element_blank(), 
              legend.position = "none")

print(p_ARI_all)

filename <- "../plots/SpatialDE_clustering/ARI_all_samples.png"
ggsave(filename, width = 5, height = 5)
```


## Plots: Normalized Mutual Information (NMI)

```{r, fig.width = 4.5, fig.height = 4.5}
# separate plots for each sample
p_NMI <- list()

for (i in seq_along(sample_names)) {
    
    d_plot_sub <- d_plot[d_plot$sample_name == sample_names[i], ]
    d_plot_sub$method <- factor(d_plot_sub$method, levels = method_names)
    
    d_plot_NMI <- distinct(d_plot_sub[, c("sample_name", "method", "NMI")])
    
    colors <- c(rep(c(rep("blue", 2), "forestgreen", "purple", "deeppink3"), 2), 
                rep(c(rep("mediumblue", 2), "darkgreen", "purple3", "deeppink4"), 2))
    
    p_NMI[[i]] <- 
        ggplot(d_plot_NMI, aes(x = method, y = NMI, color = method)) + 
            geom_point(shape = 4, stroke = 2) + 
            scale_color_manual(values = colors) + 
            ylim(c(0, 0.6)) + 
            ggtitle(paste0("Normalized Mutual Information: sample ", gsub("^sample_", "", sample_names[i]))) + 
            theme_bw() + 
            theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), 
                  axis.title.x = element_blank(), 
                  legend.position = "none")
    
    print(p_NMI[[i]])
    
    filename <- paste0("../plots/SpatialDE_clustering/NMI_sample_", 
                       gsub("^sample_", "", sample_names[i]), ".png")
    ggsave(filename, width = 4.5, height = 4.5)
}
```


```{r, fig.width = 5, fig.height = 5}
# combined boxplots showing all samples for each method
d_plot_NMI_all <- distinct(d_plot[, c("sample_name", "method", "NMI")])

d_plot_NMI_all$method <- factor(d_plot_NMI_all$method, levels = method_names)

colors <- c(rep(c(rep("blue", 2), "forestgreen", "purple", "deeppink3"), 2), 
            rep(c(rep("mediumblue", 2), "darkgreen", "purple3", "deeppink4"), 2))

p_NMI_all <- 
    ggplot(d_plot_NMI_all, aes(x = method, y = NMI, color = method)) + 
        geom_boxplot() + 
        scale_color_manual(values = colors) + 
        ylim(c(0, 0.6)) + 
        ggtitle("Normalized Mutual Information: all samples") + 
        theme_bw() + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), 
              axis.title.x = element_blank(), 
              legend.position = "none")

print(p_NMI_all)

filename <- "../plots/SpatialDE_clustering/NMI_all_samples.png"
ggsave(filename, width = 5, height = 5)
```


## Plots: summary plot

Summary plot for sample 151673 showing:
- gold standard (Kristen's manual annotation)
- clustering using marker genes (best method) (from Kristen; 77 out of 81 genes)
- unsupervised clustering (best method, i.e. SpatialDE_PCA_spatial)
- semisupervised clustering (best method) (from Leo's analyses; 198 genes)

```{r, fig.width = 14, fig.height = 3.75}
# select sample 151673
i <- 9

d_plot_sub <- d_plot[d_plot$sample_name == sample_names[i], ]

d_plot_sub$method <- factor(d_plot_sub$method, levels = method_names)
d_plot_sub$cluster <- as.factor(d_plot_sub$cluster)
d_plot_sub$truth <- as.factor(d_plot_sub$truth)

# select methods
d_plot_sub_semisupervised_best <- d_plot_sub[d_plot_sub$method == "pseudobulk_PCA_spatial", ]
d_plot_sub_unsupervised_best <- d_plot_sub[d_plot_sub$method == "SpatialDE_PCA_spatial", ]
d_plot_sub_markers_best <- d_plot_sub[d_plot_sub$method == "markers_PCA_spatial", ]

d_plot_truth_combined <- d_plot_sub[d_plot_sub$method == "pseudobulk_PCA_spatial", ]
d_plot_truth_combined <- na.omit(d_plot_truth_combined)
d_plot_truth_combined$method <- factor("ground_truth")


# re-build individual plots without facets
p_clustering_semisupervised_best <- 
    ggplot(d_plot_sub_semisupervised_best, aes(x = x_coord, y = y_coord, color = cluster)) + 
        facet_wrap(~ method) + 
        geom_point(size = 0.3, alpha = 1) + 
        coord_fixed() + 
        scale_color_manual(values = brewer.pal(8, "Paired")[c(4, 2, 3, 5, 8, 7, 6, 1)]) + 
        ggtitle("Semisupervised clustering (best)", 
                subtitle = paste0("sample ", gsub("^sample_", "", sample_names[i]))) + 
        theme_bw() + 
        theme(axis.title.x = element_blank(), 
              axis.title.y = element_blank())

p_clustering_unsupervised_best <- 
    ggplot(d_plot_sub_unsupervised_best, aes(x = x_coord, y = y_coord, color = cluster)) + 
        facet_wrap(~ method) + 
        geom_point(size = 0.3, alpha = 1) + 
        coord_fixed() + 
        scale_color_manual(values = brewer.pal(8, "Paired")[c(5, 4, 3, 8, 1, 7, 2, 6)]) + 
        ggtitle("Unsupervised clustering (best)", 
                subtitle = paste0("sample ", gsub("^sample_", "", sample_names[i]))) + 
        theme_bw() + 
        theme(axis.title.x = element_blank(), 
              axis.title.y = element_blank())

p_clustering_markers_best <- 
    ggplot(d_plot_sub_markers_best, aes(x = x_coord, y = y_coord, color = cluster)) + 
        facet_wrap(~ method) + 
        geom_point(size = 0.3, alpha = 1) + 
        coord_fixed() + 
        scale_color_manual(values = brewer.pal(8, "Paired")[c(3, 5, 7, 6, 1, 2, 4, 8)]) + 
        ggtitle("Markers clustering (best)", 
                subtitle = paste0("sample ", gsub("^sample_", "", sample_names[i]))) + 
        theme_bw() + 
        theme(axis.title.x = element_blank(), 
              axis.title.y = element_blank())

p_ground_truth_combined <- 
    ggplot(d_plot_truth_combined, aes(x = x_coord, y = y_coord, color = truth)) + 
        facet_wrap(~ method) + 
        geom_point(size = 0.3, alpha = 1) + 
        coord_fixed() + 
        scale_color_brewer(palette = "Paired") + 
        ggtitle("Ground truth", 
                subtitle = paste0("sample ", gsub("^sample_", "", sample_names[i]))) + 
        theme_bw() + 
        theme(axis.title.x = element_blank(), 
              axis.title.y = element_blank())


# combine plots using 'patchwork' package
p_combined <- p_ground_truth_combined | p_clustering_semisupervised_best | p_clustering_unsupervised_best | p_clustering_markers_best

print(p_combined)

filename <- paste0("../plots/SpatialDE_clustering/clustering_combined_best_sample_", 
                   gsub("^sample_", "", sample_names[i]), ".png")
ggsave(filename, width = 14, height = 3.75)
```




---
title: "Applying spatialDE to identify spatially DE genes"
author: Stephanie Hicks
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries
```{r}
suppressMessages({
    library(here)
    library(SingleCellExperiment)
})
```

Copy data (if needed) to be able to work with the here package.
```{r}
if(!dir.exists(here("sample_data"))){
    dir.create(here("sample_data"))
    processedData_sce_scran <- "/dcl02/lieber/ajaffe/SpatialTranscriptomics/HumanPilot/Analysis/Human_DLPFC_Visium_processedData_sce_scran.Rdata"
    file.copy(processedData_sce_scran, here("sample_data"))
}
```

Load data 
```{r}
load(here("sample_data", "Human_DLPFC_Visium_processedData_sce_scran.Rdata"))

# let's try first just picking one image
ix <- colData(sce)$sample_name == 151673
sce <- sce[, ix]

pryr::object_size(counts(sce)) # 99 MB (using sparse matrices)
tmp <- t(as.matrix(counts(sce)))
pryr::object_size(tmp) # not using sparse matrices
write.csv(tmp, quote = FALSE, row.names = TRUE,
          file = here("sample_data", "Human_DLPFC_Visium_processedData_sce_scran_counts.csv"))

is.mito <- grep("^MT-", rowData(sce)$gene_name)
df <- scater::perCellQCMetrics(sce, subsets=list(Mito=is.mito))
df <- cbind(colData(sce), df)
head(df)

write.csv(df, quote = FALSE, row.names = TRUE,
          file = here("sample_data", "Human_DLPFC_Visium_processedData_sce_scran_meta.csv"))
```

# Spatial DE 

Here I am using Python 3. 

I had to upate the numpy modules and install the scipy and pandas modules

```{bash}
module load conda_R/devel
python3 -m pip install numpy --upgrade --user
python3 -m pip install scipy --user
python3 -m pip install pandas --user
python3 -m pip install patsy --user
python3 -m pip install matplotlib --user
```

To install the [`SpatialDE`](https://github.com/Teichlab/SpatialDE) 
and [`NaiveDE`](https://github.com/Teichlab/NaiveDE) packages, use 

```{bash}
git clone git@github.com:Teichlab/SpatialDE.git
python3 -m pip install SpatialDE --user

git clone git@github.com:Teichlab/NaiveDE.git
python3 -m pip install NaiveDE --user
```

Python modules should be install `/users/<username>/.local/lib/python3.8/site-packages`

```{r}
library(reticulate)
use_python("/jhpce/shared/jhpce/core/conda/miniconda3-4.6.14/envs/svnR-devel/bin/python3")
```

Use `repl_python()` python repl from the R command. Use `exit` to exit the repl.
**Note**: Objects do not have permenancy in R after exiting the python repl.
```{python}
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib as mpl

mpl.rcParams['axes.spines.right'] = False
mpl.rcParams['axes.spines.top'] = False

import NaiveDE
import SpatialDE
```

Load count data
```{python}
counts = pd.read_csv('/fastscratch/myscratch/shicks1/HumanPilot/sample_data/Human_DLPFC_Visium_processedData_sce_scran_counts.csv', index_col=0)
counts.shape # get data frame dimension
counts = counts.T[counts.sum(axis=0) >= 30].T  # Filter practically unobserved genes

print(counts.shape)
counts.iloc[:5, :5]
```

Load spatial coordinates
```{python}
sample_info = pd.read_csv('/fastscratch/myscratch/shicks1/HumanPilot/sample_data/Human_DLPFC_Visium_processedData_sce_scran_meta.csv', index_col=0)
sample_info.shape
```

```{python}
figsize(6, 4)
plt.scatter(sample_info['imagerow'], sample_info['imagecol'], c='k');
plt.axis('equal');
plt.show()
```

Authors of spatialDE recommend using linear regression to remove technical variation 
due to library size or sequencing depth on spatial samples (will bias expression in 
every gene otherwise) before performing the spatial test.

```{python}
norm_expr = NaiveDE.stabilize(counts.T).T
resid_expr = NaiveDE.regress_out(sample_info, norm_expr.T, 'np.log(sum)').T
```

For the sake of this example, let's just run the test on 1000 random genes. This should just take a few seconds. With our very fast implementation, testing all 14,000 genes takes about 10 minutes.
```{python}
sample_resid_expr = resid_expr.sample(n=1, axis=1, random_state=1)

X = sample_info[['imagerow', 'imagecol']]
results = SpatialDE.run(X, sample_resid_expr)

# Save spatial results
results.to_csv('/fastscratch/myscratch/shicks1/HumanPilot/sample_data/Human_DLPFC_Visium_processedData_sce_scran_spatialDE_results.csv')

de_results = results[(results.qval < 0.05)].copy()
ms_results = SpatialDE.model_search(X, sample_resid_expr, de_results)

ms_results.to_csv('/fastscratch/myscratch/shicks1/HumanPilot/sample_data/Human_DLPFC_Visium_processedData_sce_scran_spatialDE_MS_results.csv')
```

